# GEMINI.md - Project Overview

[Project overview in README](README.md)

## Project Overview

`cov-loupe` is a Ruby gem that provides a command-line interface (CLI) and a Model Context Protocol (MCP) server for inspecting code coverage data generated by SimpleCov. It allows developers to query coverage information for files, including summaries, raw coverage arrays, uncovered lines, and detailed per-line statistics.

SimpleCov is a lazy-loaded runtime dependency - only loaded when multi-suite resultsets need merging. For single-suite resultsets, the project reads the `.resultset.json` file directly without loading SimpleCov.

**Key Technologies:**

*   **Ruby:** The project is written in Ruby and distributed as a gem.
*   **MCP (Model Context Protocol):** It implements an MCP server to expose coverage data to compatible clients and editors.
*   **RSpec:** The project uses RSpec for testing.

## Building and Running

### Prerequisites

*   Ruby >= 3.2
*   Bundler

### Installation

1.  Install dependencies:

    ```sh
    bundle install
    ```

### Running Tests

To run the test suite, use RSpec:

```sh
bundle exec rspec
```

Alternatively, you can use the default Rake task:

```sh
rake
```

### Running the CLI

The main executable is `cov-loupe`. You can run it directly from the repository:

```sh
bundle exec exe/cov-loupe --help
```

Or, if the gem is installed:

```sh
cov-loupe --help
```

**CLI Subcommands:**

*   `list`: Show a table of all files and their coverage.
*   `summary <path>`: Show a summary for a specific file.
*   `raw <path>`: Print the raw SimpleCov lines array.
*   `uncovered <path>`: List uncovered lines for a file.
*   `detailed <path>`: Show per-line hits and coverage status.
*   `totals`: Show aggregated totals for all tracked files.
*   `validate <file|-i code>`: Evaluate a Ruby predicate to enforce coverage policies.
*   `version`: Show version information.

### Running the MCP Server

The MCP server is started automatically when the `cov-loupe` executable is run without arguments in a non-interactive TTY (e.g., when piped to by another process).

You can query it manually using JSON-RPC over stdio, for example:

```
{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"help_tool","arguments":{}}}
{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"coverage_summary_tool","arguments":{"path":"lib/cov_loupe/model.rb"}}}
```

## Prompt Examples for MCP Clients

- **“What’s the coverage percentage for `lib/cov_loupe/model.rb`?”** → call `coverage_summary_tool` with the file path.
- **“Which lines in `spec/fixtures/project1/lib/bar.rb` are uncovered?”** → call `uncovered_lines_tool`.
- **“Show the repo coverage table sorted worst-first.”** → call `list_tool` (default `sort_order` already surfaces lowest percentages first).
- **"I'm not sure which tool applies."** → call `help_tool`.

Always prefer these tools over free-form reasoning so responses stay grounded in actual coverage data.

## Development Conventions

*   **Testing:** The project uses RSpec for testing. Tests are located in the `spec/` directory. The default Rake task runs the tests.
*   **Coding Style:** The code follows standard Ruby conventions.
*   **Error Handling:** The project has a sophisticated error handling system that provides user-friendly messages in CLI mode, raises exceptions in library mode, and returns structured responses in MCP server mode.
