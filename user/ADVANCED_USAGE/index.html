<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="MCP server, command line utility, and library for Ruby SimpleCov test coverage analysis"><link href=https://keithrbennett.github.io/cov-loupe/user/ADVANCED_USAGE/ rel=canonical><link href=../LIBRARY_API/ rel=prev><link href=../ERROR_HANDLING/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Advanced Usage - CovLoupe Documentation</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/stylesheets/branding.css><link rel=stylesheet href=../../assets/stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#advanced-usage-guide class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="CovLoupe Documentation" class="md-header__button md-logo" aria-label="CovLoupe Documentation" data-md-component=logo> <img src=../../assets/images/cov-loupe-logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> CovLoupe Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Advanced Usage </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/keithrbennett/cov-loupe title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> keithrbennett/cov-loupe </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../INSTALLATION/ class=md-tabs__link> Getting Started </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../ class=md-tabs__link> User Guide </a> </li> <li class=md-tabs__item> <a href=../migrations/ class=md-tabs__link> Migrations </a> </li> <li class=md-tabs__item> <a href=../prompts/ class=md-tabs__link> Prompt Library </a> </li> <li class=md-tabs__item> <a href=../../dev/ class=md-tabs__link> Developer Guide </a> </li> <li class=md-tabs__item> <a href=../../contributing/ class=md-tabs__link> Contributing </a> </li> <li class=md-tabs__item> <a href=../../code_of_conduct/ class=md-tabs__link> Code of Conduct </a> </li> <li class=md-tabs__item> <a href=../../release_notes/ class=md-tabs__link> Release Notes </a> </li> <li class=md-tabs__item> <a href=../../license/ class=md-tabs__link> License </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="CovLoupe Documentation" class="md-nav__button md-logo" aria-label="CovLoupe Documentation" data-md-component=logo> <img src=../../assets/images/cov-loupe-logo.png alt=logo> </a> CovLoupe Documentation </label> <div class=md-nav__source> <a href=https://github.com/keithrbennett/cov-loupe title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> keithrbennett/cov-loupe </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../INSTALLATION/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../QUICKSTART/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> <li class=md-nav__item> <a href=../EXAMPLES/ class=md-nav__link> <span class=md-ellipsis> Examples </span> </a> </li> <li class=md-nav__item> <a href=../../examples/mcp-inputs/ class=md-nav__link> <span class=md-ellipsis> MCP Input Examples </span> </a> </li> <li class=md-nav__item> <a href=../../examples/success_predicates/ class=md-nav__link> <span class=md-ellipsis> Success Predicate Examples </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> User Guide </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../CLI_USAGE/ class=md-nav__link> <span class=md-ellipsis> CLI Usage </span> </a> </li> <li class=md-nav__item> <a href=../MCP_INTEGRATION/ class=md-nav__link> <span class=md-ellipsis> MCP Integration </span> </a> </li> <li class=md-nav__item> <a href=../LIBRARY_API/ class=md-nav__link> <span class=md-ellipsis> Library API </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Advanced Usage </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Advanced Usage </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#table-of-contents class=md-nav__link> <span class=md-ellipsis> Table of Contents </span> </a> </li> <li class=md-nav__item> <a href=#advanced-mcp-integration class=md-nav__link> <span class=md-ellipsis> Advanced MCP Integration </span> </a> <nav class=md-nav aria-label="Advanced MCP Integration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mcp-error-handling class=md-nav__link> <span class=md-ellipsis> MCP Error Handling </span> </a> </li> <li class=md-nav__item> <a href=#mcp-server-logging class=md-nav__link> <span class=md-ellipsis> MCP Server Logging </span> </a> </li> <li class=md-nav__item> <a href=#testing-mcp-server-manually class=md-nav__link> <span class=md-ellipsis> Testing MCP Server Manually </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sorting-coverage-lists-with-na-entries class=md-nav__link> <span class=md-ellipsis> Sorting Coverage Lists with n/a Entries </span> </a> </li> <li class=md-nav__item> <a href=#staleness-detection-validation class=md-nav__link> <span class=md-ellipsis> Staleness Detection &amp; Validation </span> </a> <nav class=md-nav aria-label="Staleness Detection & Validation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#understanding-staleness-checks class=md-nav__link> <span class=md-ellipsis> Understanding Staleness Checks </span> </a> </li> <li class=md-nav__item> <a href=#file-level-staleness class=md-nav__link> <span class=md-ellipsis> File-Level Staleness </span> </a> </li> <li class=md-nav__item> <a href=#project-level-staleness class=md-nav__link> <span class=md-ellipsis> Project-Level Staleness </span> </a> </li> <li class=md-nav__item> <a href=#timestamp-warnings class=md-nav__link> <span class=md-ellipsis> Timestamp Warnings </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#advanced-path-resolution class=md-nav__link> <span class=md-ellipsis> Advanced Path Resolution </span> </a> <nav class=md-nav aria-label="Advanced Path Resolution"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#path-matching-strategy class=md-nav__link> <span class=md-ellipsis> Path Matching Strategy </span> </a> </li> <li class=md-nav__item> <a href=#working-with-multiple-projects class=md-nav__link> <span class=md-ellipsis> Working with Multiple Projects </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#error-handling-strategies class=md-nav__link> <span class=md-ellipsis> Error Handling Strategies </span> </a> <nav class=md-nav aria-label="Error Handling Strategies"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#context-aware-error-handling class=md-nav__link> <span class=md-ellipsis> Context-Aware Error Handling </span> </a> </li> <li class=md-nav__item> <a href=#error-modes class=md-nav__link> <span class=md-ellipsis> Error Modes </span> </a> </li> <li class=md-nav__item> <a href=#custom-error-handlers class=md-nav__link> <span class=md-ellipsis> Custom Error Handlers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#custom-ruby-integration class=md-nav__link> <span class=md-ellipsis> Custom Ruby Integration </span> </a> <nav class=md-nav aria-label="Custom Ruby Integration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#building-custom-coverage-policies class=md-nav__link> <span class=md-ellipsis> Building Custom Coverage Policies </span> </a> </li> <li class=md-nav__item> <a href=#path-relativization class=md-nav__link> <span class=md-ellipsis> Path Relativization </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#cicd-integration class=md-nav__link> <span class=md-ellipsis> CI/CD Integration </span> </a> <nav class=md-nav aria-label="CI/CD Integration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#key-integration-features class=md-nav__link> <span class=md-ellipsis> Key Integration Features </span> </a> </li> <li class=md-nav__item> <a href=#basic-ci-pattern class=md-nav__link> <span class=md-ellipsis> Basic CI Pattern </span> </a> </li> <li class=md-nav__item> <a href=#using-coverage-validation class=md-nav__link> <span class=md-ellipsis> Using Coverage Validation </span> </a> </li> <li class=md-nav__item> <a href=#platform-specific-examples class=md-nav__link> <span class=md-ellipsis> Platform-Specific Examples </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#advanced-filtering-glob-patterns class=md-nav__link> <span class=md-ellipsis> Advanced Filtering &amp; Glob Patterns </span> </a> <nav class=md-nav aria-label="Advanced Filtering & Glob Patterns"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tracked-globs-overview class=md-nav__link> <span class=md-ellipsis> Tracked Globs Overview </span> </a> </li> <li class=md-nav__item> <a href=#pattern-syntax class=md-nav__link> <span class=md-ellipsis> Pattern Syntax </span> </a> </li> <li class=md-nav__item> <a href=#use-cases class=md-nav__link> <span class=md-ellipsis> Use Cases </span> </a> </li> <li class=md-nav__item> <a href=#ruby-api-with-globs class=md-nav__link> <span class=md-ellipsis> Ruby API with Globs </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#performance-optimization class=md-nav__link> <span class=md-ellipsis> Performance Optimization </span> </a> <nav class=md-nav aria-label="Performance Optimization"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#minimizing-coverage-reads class=md-nav__link> <span class=md-ellipsis> Minimizing Coverage Reads </span> </a> </li> <li class=md-nav__item> <a href=#batch-processing class=md-nav__link> <span class=md-ellipsis> Batch Processing </span> </a> </li> <li class=md-nav__item> <a href=#filtering-early class=md-nav__link> <span class=md-ellipsis> Filtering Early </span> </a> </li> <li class=md-nav__item> <a href=#caching-coverage-models class=md-nav__link> <span class=md-ellipsis> Caching Coverage Models </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#custom-output-processing class=md-nav__link> <span class=md-ellipsis> Custom Output Processing </span> </a> <nav class=md-nav aria-label="Custom Output Processing"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#format-conversion class=md-nav__link> <span class=md-ellipsis> Format Conversion </span> </a> </li> <li class=md-nav__item> <a href=#annotated-source-output class=md-nav__link> <span class=md-ellipsis> Annotated Source Output </span> </a> </li> <li class=md-nav__item> <a href=#integration-with-coverage-trackers class=md-nav__link> <span class=md-ellipsis> Integration with Coverage Trackers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#multi-suite-coverage-merging class=md-nav__link> <span class=md-ellipsis> Multi-Suite Coverage Merging </span> </a> <nav class=md-nav aria-label="Multi-Suite Coverage Merging"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#how-it-works class=md-nav__link> <span class=md-ellipsis> How It Works </span> </a> </li> <li class=md-nav__item> <a href=#current-limitations class=md-nav__link> <span class=md-ellipsis> Current Limitations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#additional-resources class=md-nav__link> <span class=md-ellipsis> Additional Resources </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ERROR_HANDLING/ class=md-nav__link> <span class=md-ellipsis> Error Handling </span> </a> </li> <li class=md-nav__item> <a href=../TROUBLESHOOTING/ class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> <li class=md-nav__item> <a href=../CLI_FALLBACK_FOR_LLMS/ class=md-nav__link> <span class=md-ellipsis> CLI Fallback for LLMs </span> </a> </li> <li class=md-nav__item> <a href=../installing-a-prelease-version-of-covloupe/ class=md-nav__link> <span class=md-ellipsis> Installing a Prerelease </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Migrations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Migrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../migrations/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../migrations/MIGRATING_TO_V4/ class=md-nav__link> <span class=md-ellipsis> Migrating to v4 </span> </a> </li> <li class=md-nav__item> <a href=../migrations/MIGRATING_TO_V3/ class=md-nav__link> <span class=md-ellipsis> Migrating to v3 </span> </a> </li> <li class=md-nav__item> <a href=../migrations/MIGRATING_TO_V2/ class=md-nav__link> <span class=md-ellipsis> Migrating to v2 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Prompt Library </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Prompt Library </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../prompts/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../prompts/coverage-analysis-prompt/ class=md-nav__link> <span class=md-ellipsis> Coverage Analysis </span> </a> </li> <li class=md-nav__item> <a href=../prompts/use-cli-not-mcp-prompt/ class=md-nav__link> <span class=md-ellipsis> Use CLI Not MCP </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Developer Guide </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Developer Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../dev/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../dev/ARCHITECTURE/ class=md-nav__link> <span class=md-ellipsis> Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../dev/DEVELOPMENT/ class=md-nav__link> <span class=md-ellipsis> Development </span> </a> </li> <li class=md-nav__item> <a href=../../dev/RELEASING/ class=md-nav__link> <span class=md-ellipsis> Releasing </span> </a> </li> <li class=md-nav__item> <a href=../../dev/FUTURE_ENHANCEMENTS/ class=md-nav__link> <span class=md-ellipsis> Future Enhancements </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_6> <label class=md-nav__link for=__nav_6_6 id=__nav_6_6_label tabindex=0> <span class=md-ellipsis> Architecture Decisions </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6_6> <span class="md-nav__icon md-icon"></span> Architecture Decisions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../dev/arch-decisions/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../dev/arch-decisions/application-architecture/ class=md-nav__link> <span class=md-ellipsis> Application Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../dev/arch-decisions/coverage-data-quality/ class=md-nav__link> <span class=md-ellipsis> Coverage Data Quality </span> </a> </li> <li class=md-nav__item> <a href=../../dev/arch-decisions/path-resolution/ class=md-nav__link> <span class=md-ellipsis> Path Resolution </span> </a> </li> <li class=md-nav__item> <a href=../../dev/arch-decisions/policy-validation/ class=md-nav__link> <span class=md-ellipsis> Policy Validation </span> </a> </li> <li class=md-nav__item> <a href=../../dev/arch-decisions/simplecov-integration/ class=md-nav__link> <span class=md-ellipsis> SimpleCov Integration </span> </a> </li> <li class=md-nav__item> <a href=../../dev/arch-decisions/output-character-mode/ class=md-nav__link> <span class=md-ellipsis> Output Character Mode </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../dev/presentations/cov-loupe-presentation/ class=md-nav__link> <span class=md-ellipsis> Presentations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-nav__item> <a href=../../code_of_conduct/ class=md-nav__link> <span class=md-ellipsis> Code of Conduct </span> </a> </li> <li class=md-nav__item> <a href=../../release_notes/ class=md-nav__link> <span class=md-ellipsis> Release Notes </span> </a> </li> <li class=md-nav__item> <a href=../../license/ class=md-nav__link> <span class=md-ellipsis> License </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#table-of-contents class=md-nav__link> <span class=md-ellipsis> Table of Contents </span> </a> </li> <li class=md-nav__item> <a href=#advanced-mcp-integration class=md-nav__link> <span class=md-ellipsis> Advanced MCP Integration </span> </a> <nav class=md-nav aria-label="Advanced MCP Integration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mcp-error-handling class=md-nav__link> <span class=md-ellipsis> MCP Error Handling </span> </a> </li> <li class=md-nav__item> <a href=#mcp-server-logging class=md-nav__link> <span class=md-ellipsis> MCP Server Logging </span> </a> </li> <li class=md-nav__item> <a href=#testing-mcp-server-manually class=md-nav__link> <span class=md-ellipsis> Testing MCP Server Manually </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sorting-coverage-lists-with-na-entries class=md-nav__link> <span class=md-ellipsis> Sorting Coverage Lists with n/a Entries </span> </a> </li> <li class=md-nav__item> <a href=#staleness-detection-validation class=md-nav__link> <span class=md-ellipsis> Staleness Detection &amp; Validation </span> </a> <nav class=md-nav aria-label="Staleness Detection & Validation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#understanding-staleness-checks class=md-nav__link> <span class=md-ellipsis> Understanding Staleness Checks </span> </a> </li> <li class=md-nav__item> <a href=#file-level-staleness class=md-nav__link> <span class=md-ellipsis> File-Level Staleness </span> </a> </li> <li class=md-nav__item> <a href=#project-level-staleness class=md-nav__link> <span class=md-ellipsis> Project-Level Staleness </span> </a> </li> <li class=md-nav__item> <a href=#timestamp-warnings class=md-nav__link> <span class=md-ellipsis> Timestamp Warnings </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#advanced-path-resolution class=md-nav__link> <span class=md-ellipsis> Advanced Path Resolution </span> </a> <nav class=md-nav aria-label="Advanced Path Resolution"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#path-matching-strategy class=md-nav__link> <span class=md-ellipsis> Path Matching Strategy </span> </a> </li> <li class=md-nav__item> <a href=#working-with-multiple-projects class=md-nav__link> <span class=md-ellipsis> Working with Multiple Projects </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#error-handling-strategies class=md-nav__link> <span class=md-ellipsis> Error Handling Strategies </span> </a> <nav class=md-nav aria-label="Error Handling Strategies"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#context-aware-error-handling class=md-nav__link> <span class=md-ellipsis> Context-Aware Error Handling </span> </a> </li> <li class=md-nav__item> <a href=#error-modes class=md-nav__link> <span class=md-ellipsis> Error Modes </span> </a> </li> <li class=md-nav__item> <a href=#custom-error-handlers class=md-nav__link> <span class=md-ellipsis> Custom Error Handlers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#custom-ruby-integration class=md-nav__link> <span class=md-ellipsis> Custom Ruby Integration </span> </a> <nav class=md-nav aria-label="Custom Ruby Integration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#building-custom-coverage-policies class=md-nav__link> <span class=md-ellipsis> Building Custom Coverage Policies </span> </a> </li> <li class=md-nav__item> <a href=#path-relativization class=md-nav__link> <span class=md-ellipsis> Path Relativization </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#cicd-integration class=md-nav__link> <span class=md-ellipsis> CI/CD Integration </span> </a> <nav class=md-nav aria-label="CI/CD Integration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#key-integration-features class=md-nav__link> <span class=md-ellipsis> Key Integration Features </span> </a> </li> <li class=md-nav__item> <a href=#basic-ci-pattern class=md-nav__link> <span class=md-ellipsis> Basic CI Pattern </span> </a> </li> <li class=md-nav__item> <a href=#using-coverage-validation class=md-nav__link> <span class=md-ellipsis> Using Coverage Validation </span> </a> </li> <li class=md-nav__item> <a href=#platform-specific-examples class=md-nav__link> <span class=md-ellipsis> Platform-Specific Examples </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#advanced-filtering-glob-patterns class=md-nav__link> <span class=md-ellipsis> Advanced Filtering &amp; Glob Patterns </span> </a> <nav class=md-nav aria-label="Advanced Filtering & Glob Patterns"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tracked-globs-overview class=md-nav__link> <span class=md-ellipsis> Tracked Globs Overview </span> </a> </li> <li class=md-nav__item> <a href=#pattern-syntax class=md-nav__link> <span class=md-ellipsis> Pattern Syntax </span> </a> </li> <li class=md-nav__item> <a href=#use-cases class=md-nav__link> <span class=md-ellipsis> Use Cases </span> </a> </li> <li class=md-nav__item> <a href=#ruby-api-with-globs class=md-nav__link> <span class=md-ellipsis> Ruby API with Globs </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#performance-optimization class=md-nav__link> <span class=md-ellipsis> Performance Optimization </span> </a> <nav class=md-nav aria-label="Performance Optimization"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#minimizing-coverage-reads class=md-nav__link> <span class=md-ellipsis> Minimizing Coverage Reads </span> </a> </li> <li class=md-nav__item> <a href=#batch-processing class=md-nav__link> <span class=md-ellipsis> Batch Processing </span> </a> </li> <li class=md-nav__item> <a href=#filtering-early class=md-nav__link> <span class=md-ellipsis> Filtering Early </span> </a> </li> <li class=md-nav__item> <a href=#caching-coverage-models class=md-nav__link> <span class=md-ellipsis> Caching Coverage Models </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#custom-output-processing class=md-nav__link> <span class=md-ellipsis> Custom Output Processing </span> </a> <nav class=md-nav aria-label="Custom Output Processing"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#format-conversion class=md-nav__link> <span class=md-ellipsis> Format Conversion </span> </a> </li> <li class=md-nav__item> <a href=#annotated-source-output class=md-nav__link> <span class=md-ellipsis> Annotated Source Output </span> </a> </li> <li class=md-nav__item> <a href=#integration-with-coverage-trackers class=md-nav__link> <span class=md-ellipsis> Integration with Coverage Trackers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#multi-suite-coverage-merging class=md-nav__link> <span class=md-ellipsis> Multi-Suite Coverage Merging </span> </a> <nav class=md-nav aria-label="Multi-Suite Coverage Merging"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#how-it-works class=md-nav__link> <span class=md-ellipsis> How It Works </span> </a> </li> <li class=md-nav__item> <a href=#current-limitations class=md-nav__link> <span class=md-ellipsis> Current Limitations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#additional-resources class=md-nav__link> <span class=md-ellipsis> Additional Resources </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=advanced-usage-guide>Advanced Usage Guide<a class=headerlink href=#advanced-usage-guide title="Permanent link">&para;</a></h1> <p><a href=../../ >Back to main README</a></p> <blockquote> <p>Examples use <code>clp</code>, an alias pointed at the demo fixture with partial coverage:</p> <p><code>alias clp='cov-loupe -R docs/fixtures/demo_project'</code> # -R = --root</p> <p>Replace <code>clp</code> with <code>cov-loupe</code> if you want to target your own project/resultset.</p> </blockquote> <h2 id=table-of-contents>Table of Contents<a class=headerlink href=#table-of-contents title="Permanent link">&para;</a></h2> <ul> <li><a href=#advanced-mcp-integration>Advanced MCP Integration</a></li> <li><a href=#staleness-detection-validation>Staleness Detection &amp; Validation</a></li> <li><a href=#advanced-path-resolution>Advanced Path Resolution</a></li> <li><a href=#error-handling-strategies>Error Handling Strategies</a></li> <li><a href=#custom-ruby-integration>Custom Ruby Integration</a></li> <li><a href=#cicd-integration>CI/CD Integration</a></li> <li><a href=#advanced-filtering-glob-patterns>Advanced Filtering &amp; Glob Patterns</a></li> <li><a href=#performance-optimization>Performance Optimization</a></li> <li><a href=#custom-output-processing>Custom Output Processing</a></li> <li><a href=#multi-suite-coverage-merging>Multi-Suite Coverage Merging</a></li> </ul> <hr> <h2 id=advanced-mcp-integration>Advanced MCP Integration<a class=headerlink href=#advanced-mcp-integration title="Permanent link">&para;</a></h2> <h3 id=mcp-error-handling>MCP Error Handling<a class=headerlink href=#mcp-error-handling title="Permanent link">&para;</a></h3> <p>The MCP server uses structured error responses:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=p>{</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>  </span><span class=nt>&quot;jsonrpc&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2.0&quot;</span><span class=p>,</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>  </span><span class=nt>&quot;error&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>    </span><span class=nt>&quot;code&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>-32603</span><span class=p>,</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>    </span><span class=nt>&quot;message&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Coverage data not found at coverage/.resultset.json&quot;</span><span class=p>,</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>    </span><span class=nt>&quot;data&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=w>      </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;FileError&quot;</span><span class=p>,</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=w>      </span><span class=nt>&quot;context&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;MCP tool execution&quot;</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>  </span><span class=p>},</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>  </span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=p>}</span>
</code></pre></div> <h3 id=mcp-server-logging>MCP Server Logging<a class=headerlink href=#mcp-server-logging title="Permanent link">&para;</a></h3> <p>The MCP server logs to <code>cov_loupe.log</code> in the current directory by default.</p> <p>To override the default log file location, specify the <code>--log-file</code> (or <code>-l</code>) argument wherever and however you configure your MCP server. For example, to log to a different file path, include <code>-l /path/to/logfile.log</code> in your server configuration. To log to standard error, use <code>-l stderr</code>.</p> <p><strong>Warning:</strong> Log files may grow unbounded in long-running or CI usage. Consider using a log rotation tool or periodically cleaning up the log file if this is a concern.</p> <p><strong>Note:</strong> Logging to <code>stdout</code> is not permitted in MCP mode since it would interfere with the request processing.</p> <h3 id=testing-mcp-server-manually>Testing MCP Server Manually<a class=headerlink href=#testing-mcp-server-manually title="Permanent link">&para;</a></h3> <p>Use JSON-RPC over stdin to test the MCP server. <strong>Note:</strong> CLI flags set defaults for MCP tool calls, but per-request JSON parameters still win. Use <code>-R</code>/<code>-r</code> when you want server-wide defaults, or pass <code>root</code>/<code>resultset</code> per request.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1># Get version (no parameters needed)</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=nb>echo</span><span class=w> </span><span class=s1>&#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;method&quot;:&quot;tools/call&quot;,&quot;params&quot;:{&quot;name&quot;:&quot;version_tool&quot;,&quot;arguments&quot;:{}}}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>cov-loupe<span class=w> </span>-m<span class=w> </span>mcp
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=c1># Get file summary (include root parameter in JSON)</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=nb>echo</span><span class=w> </span><span class=s1>&#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:2,&quot;method&quot;:&quot;tools/call&quot;,&quot;params&quot;:{&quot;name&quot;:&quot;coverage_summary_tool&quot;,&quot;arguments&quot;:{&quot;path&quot;:&quot;app/models/order.rb&quot;,&quot;root&quot;:&quot;docs/fixtures/demo_project&quot;}}}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>cov-loupe<span class=w> </span>-m<span class=w> </span>mcp
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=c1># List all files with sorting (include root parameter)</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=nb>echo</span><span class=w> </span><span class=s1>&#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:3,&quot;method&quot;:&quot;tools/call&quot;,&quot;params&quot;:{&quot;name&quot;:&quot;list_tool&quot;,&quot;arguments&quot;:{&quot;sort_order&quot;:&quot;ascending&quot;,&quot;root&quot;:&quot;docs/fixtures/demo_project&quot;}}}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>cov-loupe<span class=w> </span>-m<span class=w> </span>mcp
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=c1># Get uncovered lines (include root parameter)</span>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=nb>echo</span><span class=w> </span><span class=s1>&#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:4,&quot;method&quot;:&quot;tools/call&quot;,&quot;params&quot;:{&quot;name&quot;:&quot;uncovered_lines_tool&quot;,&quot;arguments&quot;:{&quot;path&quot;:&quot;app/controllers/orders_controller.rb&quot;,&quot;root&quot;:&quot;docs/fixtures/demo_project&quot;}}}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>cov-loupe<span class=w> </span>-m<span class=w> </span>mcp
</code></pre></div> <p><strong>Why not use <code>clp</code> alias here?</strong> <code>clp</code> is useful for CLI subcommands, but MCP calls run a long-lived server process. You can pass <code>-R</code> at startup to set defaults, or set <code>root</code> explicitly in each JSON request when you want to be explicit or override the defaults.</p> <hr> <h2 id=sorting-coverage-lists-with-na-entries>Sorting Coverage Lists with n/a Entries<a class=headerlink href=#sorting-coverage-lists-with-na-entries title="Permanent link">&para;</a></h2> <p>When a file has no executable lines, its coverage percentage is reported as <code>n/a</code>. In list outputs, <code>n/a</code> entries are grouped separately from numeric percentages. The default descending sort order places <code>n/a</code> entries above <code>100%</code> coverage so they appear earlier in the list, while still keeping low numeric percentages toward the bottom for attention.</p> <p>If you need to treat <code>n/a</code> differently, post-process the JSON output from <code>list</code> or <code>list_tool</code> and apply your own sort or filtering rules.</p> <hr> <h2 id=staleness-detection-validation>Staleness Detection &amp; Validation<a class=headerlink href=#staleness-detection-validation title="Permanent link">&para;</a></h2> <h3 id=understanding-staleness-checks>Understanding Staleness Checks<a class=headerlink href=#understanding-staleness-checks title="Permanent link">&para;</a></h3> <p>Staleness checking prevents using outdated coverage data. The behavior is controlled by the boolean <code>raise_on_stale</code> setting:</p> <p><strong><code>raise_on_stale: false</code> (default)</strong> - Coverage data is returned even if stale - Stale indicators are still computed - Best for exploratory reporting</p> <p><strong><code>raise_on_stale: true</code></strong> - Raises errors when stale coverage is detected - Recommended for CI/CD enforcement</p> <h3 id=file-level-staleness>File-Level Staleness<a class=headerlink href=#file-level-staleness title="Permanent link">&para;</a></h3> <p>A file is considered stale when any of the following are true: 1. Source file modified after coverage generation (requires timestamps - see <a href=#timestamp-warnings>Timestamp Warnings</a>) 2. Line count differs from coverage array length 3. File exists in coverage but deleted from filesystem</p> <p><strong>CLI Usage:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1># Fail if the file is stale</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>clp<span class=w> </span>-S<span class=w> </span><span class=nb>true</span><span class=w> </span>summary<span class=w> </span>app/models/order.rb<span class=w>  </span><span class=c1># -S = --raise-on-stale</span>
</code></pre></div></p> <p><strong>Ruby API:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span><span class=p>(</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>  </span><span class=ss>raise_on_stale</span><span class=p>:</span><span class=w> </span><span class=kp>true</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=p>)</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=k>begin</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>  </span><span class=n>summary</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>summary_for</span><span class=p>(</span><span class=s1>&#39;app/models/order.rb&#39;</span><span class=p>)</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=k>rescue</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageDataStaleError</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>e</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;File modified after coverage: </span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;Coverage timestamp: </span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>cov_timestamp</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;File mtime: </span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>file_mtime</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;Source lines: </span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>src_len</span><span class=si>}</span><span class=s2>, Coverage lines: </span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>cov_len</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=k>end</span>
</code></pre></div></p> <h3 id=project-level-staleness>Project-Level Staleness<a class=headerlink href=#project-level-staleness title="Permanent link">&para;</a></h3> <p>Detects system-wide staleness issues:</p> <p><strong>Conditions Checked:</strong> 1. <strong>Newer files</strong> - Any tracked file modified after coverage (requires timestamps - see <a href=#timestamp-warnings>Timestamp Warnings</a>) 2. <strong>Missing files</strong> - Tracked files with no coverage data 3. <strong>Deleted files</strong> - Coverage exists for non-existent files</p> <p><strong>CLI Usage:</strong></p> <p>You can see if <em>any</em> files in the project are stale by running the (implicit here) <code>list</code> command with <code>--raise-on-stale</code> and checking the exit code:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>$<span class=w> </span>cov-loupe<span class=w> </span>-S<span class=w> </span><span class=nb>true</span><span class=w> </span>list
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>Coverage<span class=w> </span>data<span class=w> </span>stale<span class=w> </span><span class=o>(</span>project<span class=o>)</span>:<span class=w> </span>CovLoupe::CoverageDataProjectStaleError
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>Coverage<span class=w>  </span>-<span class=w> </span>time:<span class=w> </span><span class=m>2025</span>-12-10T18:23:00Z<span class=w> </span><span class=o>(</span><span class=nb>local</span><span class=w> </span><span class=m>2025</span>-12-11T02:23:00+08:00<span class=o>)</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>Newer<span class=w> </span>files<span class=w> </span><span class=o>(</span><span class=m>1</span><span class=o>)</span>:<span class=w>  </span>-<span class=w> </span>lib/cov_loupe/version.rb
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>Resultset<span class=w> </span>-<span class=w> </span>/path/to/project/coverage/.resultset.json
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>$<span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=nv>$?</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=m>1</span>
</code></pre></div> <p><strong>Ruby API:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>raise_on_stale</span><span class=p>:</span><span class=w> </span><span class=kp>true</span><span class=p>)</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=k>begin</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>  </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=p>(</span><span class=ss>raise_on_stale</span><span class=p>:</span><span class=w> </span><span class=kp>true</span><span class=p>)</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=k>rescue</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageDataProjectStaleError</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>e</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;Newer files: </span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>newer_files</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;Missing from coverage: </span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>missing_files</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;Deleted but in coverage: </span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>deleted_files</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=k>end</span>
</code></pre></div></p> <h3 id=timestamp-warnings>Timestamp Warnings<a class=headerlink href=#timestamp-warnings title="Permanent link">&para;</a></h3> <p>When coverage data lacks timestamps (e.g., manually created resultsets or older SimpleCov versions), cov-loupe displays a warning in both CLI and MCP modes:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>WARNING: Coverage timestamps are missing. Time-based staleness checks were skipped.
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>Files may appear &quot;ok&quot; even if source code is newer than the coverage data.
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>Check your coverage tool configuration to ensure timestamps are recorded.
</code></pre></div> <p><strong>What this means:</strong> - Time-based staleness checks (the <code>"newer"</code> indicator) cannot run without timestamps - Files modified after coverage collection won't be flagged as stale - Only line count mismatches and missing files will be detected - The <code>timestamp_status</code> field in JSON output will show <code>"missing"</code> instead of <code>"ok"</code></p> <p><strong>Where it appears:</strong> - <strong>CLI table format:</strong> After the coverage table in <code>list</code> output - <strong>CLI JSON format:</strong> After JSON output, and in the <code>timestamp_status</code> field - <strong>MCP mode:</strong> In <code>coverage_table_tool</code> output after the exclusions summary - <strong>MCP JSON:</strong> In the <code>timestamp_status</code> field of <code>list_tool</code> responses</p> <p><strong>How to fix:</strong></p> <p>Modern SimpleCov versions automatically include timestamps in <code>.resultset.json</code>. If you see this warning:</p> <ol> <li>Ensure SimpleCov is up to date (<code>gem update simplecov</code>)</li> <li>Regenerate coverage data (<code>bundle exec rspec</code>)</li> <li>If using custom resultset generation, ensure timestamps are included</li> </ol> <p><strong>Example timestamp in <code>.resultset.json</code>:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=p>{</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>  </span><span class=nt>&quot;RSpec&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>    </span><span class=nt>&quot;coverage&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=err>...</span><span class=w> </span><span class=p>},</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>    </span><span class=nt>&quot;timestamp&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1704067200</span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=p>}</span>
</code></pre></div></p> <hr> <h2 id=advanced-path-resolution>Advanced Path Resolution<a class=headerlink href=#advanced-path-resolution title="Permanent link">&para;</a></h2> <h3 id=path-matching-strategy>Path Matching Strategy<a class=headerlink href=#path-matching-strategy title="Permanent link">&para;</a></h3> <p>Path resolution uses two strategies in order:</p> <ol> <li><strong>Exact absolute path match</strong> - Direct lookup using the full path</li> <li><strong>Relative path resolution</strong> - Strips project root and retries with relative path</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>root</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/path/to/project&#39;</span><span class=p>)</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=n>model</span><span class=o>.</span><span class=n>summary_for</span><span class=p>(</span><span class=s1>&#39;/path/to/project/app/models/order.rb&#39;</span><span class=p>)</span><span class=w>  </span><span class=c1># Absolute</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=n>model</span><span class=o>.</span><span class=n>summary_for</span><span class=p>(</span><span class=s1>&#39;app/models/order.rb&#39;</span><span class=p>)</span><span class=w>                   </span><span class=c1># Relative</span>
</code></pre></div> <h3 id=working-with-multiple-projects>Working with Multiple Projects<a class=headerlink href=#working-with-multiple-projects title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1># Project A</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=n>model_a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span><span class=p>(</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>  </span><span class=ss>root</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/path/to/projects/service-a&#39;</span><span class=p>,</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>  </span><span class=ss>resultset</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/path/to/projects/service-a/coverage/.resultset.json&#39;</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=p>)</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=c1># Project B</span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=n>model_b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span><span class=p>(</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=w>  </span><span class=ss>root</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/path/to/projects/service-b&#39;</span><span class=p>,</span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>  </span><span class=ss>resultset</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/path/to/projects/service-b/tmp/coverage/.resultset.json&#39;</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=p>)</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=c1># Compare coverage</span>
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=n>coverage_a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model_a</span><span class=o>.</span><span class=n>list</span>
<a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=n>coverage_b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model_b</span><span class=o>.</span><span class=n>list</span>
</code></pre></div> <hr> <h2 id=error-handling-strategies>Error Handling Strategies<a class=headerlink href=#error-handling-strategies title="Permanent link">&para;</a></h2> <h3 id=context-aware-error-handling>Context-Aware Error Handling<a class=headerlink href=#context-aware-error-handling title="Permanent link">&para;</a></h3> <p><strong>CLI Mode:</strong> user-facing messages, exit codes, optional debug mode</p> <p><strong>Library Mode:</strong> typed exceptions with full details</p> <p><strong>MCP Server Mode:</strong> JSON-RPC errors logged to file with structured data</p> <h3 id=error-modes>Error Modes<a class=headerlink href=#error-modes title="Permanent link">&para;</a></h3> <p><strong>CLI Error Modes:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1># Silent mode - minimal output</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>clp<span class=w> </span>--error-mode<span class=w> </span>off<span class=w> </span>summary<span class=w> </span>app/models/order.rb
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=c1># Standard mode - user-friendly errors (default)</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>clp<span class=w> </span>--error-mode<span class=w> </span>log<span class=w> </span>summary<span class=w> </span>app/models/order.rb
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=c1># Verbose mode - full stack traces</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>clp<span class=w> </span>--error-mode<span class=w> </span>debug<span class=w> </span>summary<span class=w> </span>app/models/order.rb
</code></pre></div></p> <p><strong>Ruby API Error Handling:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=nb>require</span><span class=w> </span><span class=s1>&#39;cov_loupe&#39;</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=k>begin</span>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>  </span><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span><span class=p>(</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>    </span><span class=ss>root</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/path/to/project&#39;</span><span class=p>,</span>
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>    </span><span class=ss>resultset</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/nonexistent/.resultset.json&#39;</span>
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>  </span><span class=p>)</span>
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=k>rescue</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>FileError</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>e</span>
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>  </span><span class=c1># Handle missing resultset</span>
<a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;Coverage file not found: </span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>message</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=k>rescue</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageDataError</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>e</span>
<a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>  </span><span class=c1># Handle corrupt/invalid coverage data</span>
<a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;Invalid coverage data: </span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>message</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=k>end</span>
</code></pre></div></p> <h3 id=custom-error-handlers>Custom Error Handlers<a class=headerlink href=#custom-error-handlers title="Permanent link">&para;</a></h3> <p>Provide custom error handlers when embedding the CLI:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>class</span><span class=w> </span><span class=nc>CustomErrorHandler</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=w>  </span><span class=k>def</span><span class=w> </span><span class=nf>handle_error</span><span class=p>(</span><span class=n>error</span><span class=p>,</span><span class=w> </span><span class=ss>context</span><span class=p>:</span><span class=w> </span><span class=kp>nil</span><span class=p>)</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>    </span><span class=c1># Log to custom service</span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=w>    </span><span class=no>ErrorTracker</span><span class=o>.</span><span class=n>notify</span><span class=p>(</span><span class=n>error</span><span class=p>,</span><span class=w> </span><span class=ss>context</span><span class=p>:</span><span class=w> </span><span class=n>context</span><span class=p>)</span>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=w>    </span><span class=c1># Re-raise or handle gracefully</span>
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>    </span><span class=k>raise</span><span class=w> </span><span class=n>error</span>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>  </span><span class=k>end</span>
<a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=k>end</span>
<a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>
<a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=n>cli</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageCLI</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>error_handler</span><span class=p>:</span><span class=w> </span><span class=no>CustomErrorHandler</span><span class=o>.</span><span class=n>new</span><span class=p>)</span>
</code></pre></div> <hr> <h2 id=custom-ruby-integration>Custom Ruby Integration<a class=headerlink href=#custom-ruby-integration title="Permanent link">&para;</a></h2> <h3 id=building-custom-coverage-policies>Building Custom Coverage Policies<a class=headerlink href=#building-custom-coverage-policies title="Permanent link">&para;</a></h3> <p>Use the <code>validate</code> subcommand to enforce custom coverage policies in CI/CD. Example predicates are in <a href=../../examples/success_predicates/ ><code>examples/success_predicates/</code></a>.</p> <p>The predicate can be any Ruby object that responds to <code>call</code> and accepts a <code>CoverageModel</code> as its argument. This is usually a lambda (proc), but it can also be a nonlambda proc, a class, or an instance with a <code>call</code> method. The predicate should return a truthy value for success or <code>false</code>/<code>nil</code> for failure.</p> <blockquote> <p><strong> SECURITY WARNING</strong></p> <p>Success predicates execute as <strong>arbitrary Ruby code with full system privileges</strong>. They have unrestricted access to: - File system operations (read, write, delete) - Network operations (HTTP requests, sockets) - System commands (via backticks, <code>system()</code>, <code>exec()</code>, etc.) - Environment variables and sensitive data</p> <p><strong>Only use predicate files from trusted sources.</strong> Treat them like any other executable code in your project. - Never use predicates from untrusted or unknown sources - Review predicates before use, especially in CI/CD environments - Store predicates in version control with code review - Be cautious when copying examples from the internet</p> </blockquote> <p><strong>Quick Usage:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1># All files must be &gt;= 80%</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>clp<span class=w> </span>validate<span class=w> </span>examples/success_predicates/list_above_threshold_predicate.rb
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=c1># Total project coverage &gt;= 85%</span>
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>clp<span class=w> </span>validate<span class=w> </span>examples/success_predicates/project_coverage_minimum_predicate.rb
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>
<a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=c1># Custom predicate from file</span>
<a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a>clp<span class=w> </span>validate<span class=w> </span>coverage_policy.rb
<a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a>
<a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=c1># Inline string mode</span>
<a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>clp<span class=w> </span>validate<span class=w> </span>-i<span class=w> </span><span class=s1>&#39;-&gt;(m) { m.list[&quot;files&quot;].all? { |f| f[&quot;percentage&quot;] &gt;= 80 } }&#39;</span>
</code></pre></div></p> <p><strong>Creating a predicate:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=c1># coverage_policy.rb</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=o>-&gt;</span><span class=p>(</span><span class=n>model</span><span class=p>)</span><span class=w> </span><span class=k>do</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=w>  </span><span class=c1># All files must have &gt;= 80% coverage</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>  </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>].</span><span class=n>all?</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>|</span><span class=n>f</span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;percentage&#39;</span><span class=o>]</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>80</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=k>end</span>
</code></pre></div></p> <p><strong>Advanced predicate with reporting:</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1># coverage_policy.rb</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=k>class</span><span class=w> </span><span class=nc>CoveragePolicy</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>  </span><span class=k>def</span><span class=w> </span><span class=nf>call</span><span class=p>(</span><span class=n>model</span><span class=p>)</span>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>    </span><span class=n>threshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>80</span>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>    </span><span class=n>low_files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>].</span><span class=n>select</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>|</span><span class=n>f</span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;percentage&#39;</span><span class=o>]</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>threshold</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>low_files</span><span class=o>.</span><span class=n>empty?</span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=w>      </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot; All files have &gt;= </span><span class=si>#{</span><span class=n>threshold</span><span class=si>}</span><span class=s2>% coverage&quot;</span>
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=w>      </span><span class=kp>true</span>
<a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=w>    </span><span class=k>else</span>
<a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=w>      </span><span class=nb>warn</span><span class=w> </span><span class=s2>&quot; Files below </span><span class=si>#{</span><span class=n>threshold</span><span class=si>}</span><span class=s2>%:&quot;</span>
<a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=w>      </span><span class=n>low_files</span><span class=o>.</span><span class=n>each</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>|</span><span class=n>f</span><span class=o>|</span><span class=w> </span><span class=nb>warn</span><span class=w> </span><span class=s2>&quot;  </span><span class=si>#{</span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;file&#39;</span><span class=o>]</span><span class=si>}</span><span class=s2>: </span><span class=si>#{</span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;percentage&#39;</span><span class=o>]</span><span class=si>}</span><span class=s2>%&quot;</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=w>      </span><span class=kp>false</span>
<a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=w>    </span><span class=k>end</span>
<a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=w>  </span><span class=k>end</span>
<a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=k>end</span>
<a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a>
<a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a><span class=no>CoveragePolicy</span><span class=o>.</span><span class=n>new</span>
</code></pre></div> <p><strong>Exit codes:</strong> - <code>0</code> - Predicate returned truthy (pass) - <code>1</code> - Predicate returned falsy (fail) - <code>2</code> - Predicate raised an error</p> <p>See <a href=../../examples/success_predicates/ >examples/success_predicates/README.md</a> for more examples.</p> <h3 id=path-relativization>Path Relativization<a class=headerlink href=#path-relativization title="Permanent link">&para;</a></h3> <p>Convert absolute paths to relative for cleaner output:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>root</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/path/to/project&#39;</span><span class=p>)</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=c1># Get data with absolute paths</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>summary_for</span><span class=p>(</span><span class=s1>&#39;app/models/order.rb&#39;</span><span class=p>)</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=c1># =&gt; { &#39;file&#39; =&gt; &#39;/path/to/project/app/models/order.rb&#39;, ... }</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=c1># Relativize paths</span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=n>relative_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>relativize</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=c1># =&gt; { &#39;file&#39; =&gt; &#39;app/models/order.rb&#39;, ... }</span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=c1># Works with list payloads too</span>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=n>list_result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>list</span>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=n>relative_list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>relativize</span><span class=p>(</span><span class=n>list_result</span><span class=p>)</span>
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=n>relative_files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>relative_list</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>]</span>
</code></pre></div> <hr> <h2 id=cicd-integration>CI/CD Integration<a class=headerlink href=#cicd-integration title="Permanent link">&para;</a></h2> <p>The CLI is designed for CI/CD use with features that integrate naturally into pipeline workflows:</p> <h3 id=key-integration-features>Key Integration Features<a class=headerlink href=#key-integration-features title="Permanent link">&para;</a></h3> <ul> <li><strong>Exit codes</strong>: Non-zero on failure, making it suitable for pipeline failure conditions</li> <li><strong>JSON output</strong>: <code>-fJ</code> format for parsing by CI tools and custom processing</li> <li><strong>Staleness checking</strong>: <code>--raise-on-stale true</code> to fail on outdated coverage data</li> <li><strong>Success predicates</strong>: Custom Ruby policies for coverage enforcement</li> </ul> <h3 id=basic-ci-pattern>Basic CI Pattern<a class=headerlink href=#basic-ci-pattern title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=c1># 1. Run tests to generate coverage</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>bundle<span class=w> </span><span class=nb>exec</span><span class=w> </span>rspec
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=c1># 2. Validate coverage freshness (fails with exit code 1 if stale)</span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>clp<span class=w> </span>-S<span class=w> </span><span class=nb>true</span><span class=w> </span>-g<span class=w> </span><span class=s2>&quot;lib/**/*.rb&quot;</span>
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=c1># 3. Export data for CI artifacts or further processing</span>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>clp<span class=w> </span>-fJ<span class=w> </span>list<span class=w> </span>&gt;<span class=w> </span>coverage.json
</code></pre></div> <h3 id=using-coverage-validation>Using Coverage Validation<a class=headerlink href=#using-coverage-validation title="Permanent link">&para;</a></h3> <p>Enforce custom coverage policies with the <code>validate</code> subcommand:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1># Run tests</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>bundle<span class=w> </span><span class=nb>exec</span><span class=w> </span>rspec
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=c1># Apply coverage policy (fails with exit code 1 if predicate returns false)</span>
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>clp<span class=w> </span>validate<span class=w> </span>coverage_policy.rb
</code></pre></div> <p>Exit codes: - <code>0</code> - Success (coverage meets requirements) - <code>1</code> - Failure (coverage policy not met or stale data detected) - <code>2</code> - Error (invalid predicate or system error)</p> <h3 id=platform-specific-examples>Platform-Specific Examples<a class=headerlink href=#platform-specific-examples title="Permanent link">&para;</a></h3> <p>For platform-specific integration examples (GitHub Actions, GitLab CI, Jenkins, CircleCI, etc.), see community contributions in the <a href=https://github.com/keithrbennett/cov-loupe/discussions>GitHub Discussions</a>.</p> <hr> <h2 id=advanced-filtering-glob-patterns>Advanced Filtering &amp; Glob Patterns<a class=headerlink href=#advanced-filtering-glob-patterns title="Permanent link">&para;</a></h2> <h3 id=tracked-globs-overview>Tracked Globs Overview<a class=headerlink href=#tracked-globs-overview title="Permanent link">&para;</a></h3> <p><strong>Default behavior:</strong> By default, <code>--tracked-globs</code> is empty (<code>[]</code>), which means all files in the coverage resultset are shown. This ensures transparencyyou see exactly what SimpleCov measured without any filtering.</p> <p><strong>Why opt-in filtering?</strong> - <strong>Coverage results are not hidden</strong> - Results are not excluded because their filespecs did not match default tracked globs - <strong>Meaningful validation</strong> - <code>missing_tracked_files</code> only flags files you explicitly expect to have coverage - <strong>Project flexibility</strong> - Different projects use different directory structures</p> <p><strong>Important:</strong> Files lacking any coverage at all (not loaded during tests) will not appear in the resultset and therefore won't be visible with the default empty array. To detect such files, you must set <code>--tracked-globs</code> to match the files you expect to have coverage.</p> <p><strong>Two purposes of tracked globs:</strong> 1. <strong>Exclude unwanted results</strong> - Only show files from the resultset that match the patterns 2. <strong>Include files with or without coverage</strong> - Report files that match the patterns but aren't in the resultset (reported in <code>missing_tracked_files</code> for <code>list</code>, <code>missing_from_coverage</code> for <code>totals</code>)</p> <p><strong>Best practice:</strong> Set <code>COV_LOUPE_OPTS</code> to match your SimpleCov <code>track_files</code> configuration:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=c1># spec_helper.rb</span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=no>SimpleCov</span><span class=o>.</span><span class=n>start</span><span class=w> </span><span class=k>do</span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=w>  </span><span class=n>add_filter</span><span class=w> </span><span class=s1>&#39;/spec/&#39;</span>
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=w>  </span><span class=n>track_files</span><span class=w> </span><span class=s1>&#39;lib/**/*.rb&#39;</span>
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=w>  </span><span class=n>track_files</span><span class=w> </span><span class=s1>&#39;app/**/*.rb&#39;</span>
<a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=k>end</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1># Shell config (.bashrc, .zshrc, etc.)</span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=nb>export</span><span class=w> </span><span class=nv>COV_LOUPE_OPTS</span><span class=o>=</span><span class=s2>&quot;--tracked-globs lib/**/*.rb,app/**/*.rb&quot;</span>
</code></pre></div> <p>This alignment ensures: - <code>list</code> and <code>totals</code> output matches SimpleCov's scope - <code>missing_tracked_files</code> (in <code>list</code>) reports files that SimpleCov should track but hasn't measured - No surprises from default patterns that don't match your project</p> <h3 id=pattern-syntax>Pattern Syntax<a class=headerlink href=#pattern-syntax title="Permanent link">&para;</a></h3> <p>Uses Ruby's <code>File.fnmatch</code> with extended glob support:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=c1># Single directory, recursive</span>
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>-g<span class=w> </span><span class=s2>&quot;lib/**/*.rb&quot;</span>
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=c1># Multiple patterns</span>
<a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>-g<span class=w> </span><span class=s2>&quot;lib/payments/**/*.rb&quot;</span><span class=w> </span>-g<span class=w> </span><span class=s2>&quot;lib/ops/jobs/**/*.rb&quot;</span>
<a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>
<a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=c1># Exclude patterns (use CLI filtering to exclude ops jobs)</span>
<a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>clp<span class=w> </span>-fJ<span class=w> </span>list<span class=w> </span><span class=p>|</span><span class=w> </span>jq<span class=w> </span><span class=s1>&#39;.files[] | select(.file | test(&quot;ops&quot;) | not)&#39;</span>
<a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a>
<a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=c1># Ruby alternative:</span>
<a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a>clp<span class=w> </span>-fJ<span class=w> </span>list<span class=w> </span><span class=p>|</span><span class=w> </span>ruby<span class=w> </span>-r<span class=w> </span>json<span class=w> </span>-e<span class=w> </span><span class=s1>&#39;</span>
<a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=s1>  JSON.parse($stdin.read)[&quot;files&quot;].reject { |f| f[&quot;file&quot;].include?(&quot;ops&quot;) }.each do |f|</span>
<a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=s1>    puts JSON.pretty_generate(f)</span>
<a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=s1>  end</span>
<a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=s1>&#39;</span>
<a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a>
<a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=c1># Rexe alternative:</span>
<a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a>clp<span class=w> </span>-fJ<span class=w> </span>list<span class=w> </span><span class=p>|</span><span class=w> </span>rexe<span class=w> </span>-ij<span class=w> </span>-mb<span class=w> </span>-oJ<span class=w> </span><span class=s1>&#39;self[&quot;files&quot;].reject { |f| f[&quot;file&quot;].include?(&quot;ops&quot;) }&#39;</span>
<a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a>
<a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a><span class=c1># Complex patterns</span>
<a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a>-g<span class=w> </span><span class=s2>&quot;lib/{models,controllers}/**/*.rb&quot;</span>
<a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a>-g<span class=w> </span><span class=s2>&quot;app/**/concerns/*.rb&quot;</span>
</code></pre></div> <h3 id=use-cases>Use Cases<a class=headerlink href=#use-cases title="Permanent link">&para;</a></h3> <p><strong>1. Monitor Subsystem Coverage:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=c1># API layer only</span>
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>clp<span class=w> </span>-g<span class=w> </span><span class=s2>&quot;lib/api/**/*.rb&quot;</span><span class=w> </span>list
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>
<a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=c1># Core business logic</span>
<a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a>clp<span class=w> </span>-g<span class=w> </span><span class=s2>&quot;lib/domain/**/*.rb&quot;</span><span class=w> </span>list
</code></pre></div></p> <p><strong>2. Ensure New Files Have Coverage:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=c1># Fail if any tracked file lacks coverage</span>
<a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>clp<span class=w> </span>-S<span class=w> </span><span class=nb>true</span><span class=w> </span>-g<span class=w> </span><span class=s2>&quot;lib/features/**/*.rb&quot;</span>
</code></pre></div></p> <p><strong>3. Multi-tier Reporting:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=c1># Generate separate reports per layer</span>
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=k>for</span><span class=w> </span>layer<span class=w> </span><span class=k>in</span><span class=w> </span>models<span class=w> </span>views<span class=w> </span>controllers<span class=p>;</span><span class=w> </span><span class=k>do</span>
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=w>  </span>clp<span class=w> </span>-g<span class=w> </span><span class=s2>&quot;app/</span><span class=si>${</span><span class=nv>layer</span><span class=si>}</span><span class=s2>/**/*.rb&quot;</span><span class=w> </span>-fJ<span class=w> </span>list<span class=w> </span>&gt;<span class=w> </span><span class=s2>&quot;coverage-</span><span class=si>${</span><span class=nv>layer</span><span class=si>}</span><span class=s2>.json&quot;</span>
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=k>done</span>
</code></pre></div></p> <h3 id=ruby-api-with-globs>Ruby API with Globs<a class=headerlink href=#ruby-api-with-globs title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=c1># Filter files in output</span>
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=n>api_files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=p>(</span>
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=w>  </span><span class=ss>tracked_globs</span><span class=p>:</span><span class=w> </span><span class=o>[</span><span class=s1>&#39;lib/api/**/*.rb&#39;</span><span class=o>]</span>
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=p>)</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>]</span>
<a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a>
<a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=c1># Multi-pattern filtering</span>
<a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=n>core_files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=p>(</span>
<a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=w>  </span><span class=ss>tracked_globs</span><span class=p>:</span><span class=w> </span><span class=o>[</span>
<a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=w>    </span><span class=s1>&#39;lib/core/**/*.rb&#39;</span><span class=p>,</span>
<a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=w>    </span><span class=s1>&#39;lib/domain/**/*.rb&#39;</span>
<a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=w>  </span><span class=o>]</span>
<a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=p>)</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>]</span>
<a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a>
<a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=c1># Validate specific subsystems</span>
<a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a><span class=k>begin</span>
<a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=w>  </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=p>(</span>
<a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a><span class=w>    </span><span class=ss>raise_on_stale</span><span class=p>:</span><span class=w> </span><span class=kp>true</span><span class=p>,</span>
<a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a><span class=w>    </span><span class=ss>tracked_globs</span><span class=p>:</span><span class=w> </span><span class=o>[</span><span class=s1>&#39;lib/critical/**/*.rb&#39;</span><span class=o>]</span>
<a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a><span class=w>  </span><span class=p>)</span>
<a id=__codelineno-25-22 name=__codelineno-25-22 href=#__codelineno-25-22></a><span class=k>rescue</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageDataProjectStaleError</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>e</span>
<a id=__codelineno-25-23 name=__codelineno-25-23 href=#__codelineno-25-23></a><span class=w>  </span><span class=c1># Handle missing coverage for critical files</span>
<a id=__codelineno-25-24 name=__codelineno-25-24 href=#__codelineno-25-24></a><span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;Critical files missing coverage:&quot;</span>
<a id=__codelineno-25-25 name=__codelineno-25-25 href=#__codelineno-25-25></a><span class=w>  </span><span class=n>e</span><span class=o>.</span><span class=n>missing_files</span><span class=o>.</span><span class=n>each</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>|</span><span class=n>f</span><span class=o>|</span><span class=w> </span><span class=nb>puts</span><span class=w> </span><span class=s2>&quot;  - </span><span class=si>#{</span><span class=n>f</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-25-26 name=__codelineno-25-26 href=#__codelineno-25-26></a><span class=k>end</span>
</code></pre></div> <hr> <h2 id=performance-optimization>Performance Optimization<a class=headerlink href=#performance-optimization title="Permanent link">&para;</a></h2> <h3 id=minimizing-coverage-reads>Minimizing Coverage Reads<a class=headerlink href=#minimizing-coverage-reads title="Permanent link">&para;</a></h3> <p>The <code>CoverageModel</code> reads <code>.resultset.json</code> once at initialization:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=c1># Good: Single model for multiple queries</span>
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span>
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=n>files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>]</span>
<a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=n>file1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>summary_for</span><span class=p>(</span><span class=s1>&#39;lib/a.rb&#39;</span><span class=p>)</span>
<a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=n>file2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>summary_for</span><span class=p>(</span><span class=s1>&#39;lib/b.rb&#39;</span><span class=p>)</span>
<a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a>
<a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=c1># Bad: Re-reads coverage for each operation</span>
<a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=n>model1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span>
<a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=n>files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model1</span><span class=o>.</span><span class=n>list</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>]</span>
<a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a>
<a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=n>model2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span>
<a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=n>file1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model2</span><span class=o>.</span><span class=n>summary_for</span><span class=p>(</span><span class=s1>&#39;lib/a.rb&#39;</span><span class=p>)</span>
</code></pre></div> <h3 id=batch-processing>Batch Processing<a class=headerlink href=#batch-processing title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=c1># Process multiple files in one pass</span>
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=n>files_to_analyze</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=s1>&#39;lib/a.rb&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;lib/b.rb&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;lib/c.rb&#39;</span><span class=o>]</span>
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span>
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a>
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=n>results</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>files_to_analyze</span><span class=o>.</span><span class=n>each_with_object</span><span class=p>({})</span><span class=w> </span><span class=k>do</span><span class=w> </span><span class=o>|</span><span class=n>file</span><span class=p>,</span><span class=w> </span><span class=nb>hash</span><span class=o>|</span>
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=w>  </span><span class=nb>hash</span><span class=o>[</span><span class=n>file</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=w>    </span><span class=ss>summary</span><span class=p>:</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>summary_for</span><span class=p>(</span><span class=n>file</span><span class=p>),</span>
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=w>    </span><span class=ss>uncovered</span><span class=p>:</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>uncovered_for</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=k>rescue</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>FileError</span>
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=w>  </span><span class=nb>hash</span><span class=o>[</span><span class=n>file</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=ss>error</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;No coverage&#39;</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=k>end</span>
</code></pre></div> <h3 id=filtering-early>Filtering Early<a class=headerlink href=#filtering-early title="Permanent link">&para;</a></h3> <p>Use <code>tracked_globs</code> to reduce data processing:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=c1># Bad: Filter after loading all data</span>
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>]</span>
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=n>api_files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=o>.</span><span class=n>select</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>|</span><span class=n>f</span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;file&#39;</span><span class=o>].</span><span class=n>include?</span><span class=p>(</span><span class=s1>&#39;api&#39;</span><span class=p>)</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>
<a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=c1># Good: Filter during query</span>
<a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=n>api_files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=p>(</span>
<a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=w>  </span><span class=ss>tracked_globs</span><span class=p>:</span><span class=w> </span><span class=o>[</span><span class=s1>&#39;lib/api/**/*.rb&#39;</span><span class=o>]</span>
<a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=p>)</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>]</span>
</code></pre></div> <h3 id=caching-coverage-models>Caching Coverage Models<a class=headerlink href=#caching-coverage-models title="Permanent link">&para;</a></h3> <p>For long-running processes:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=k>class</span><span class=w> </span><span class=nc>CoverageCache</span>
<a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=w>  </span><span class=k>def</span><span class=w> </span><span class=nf>initialize</span><span class=p>(</span><span class=ss>ttl</span><span class=p>:</span><span class=w> </span><span class=mi>300</span><span class=p>)</span><span class=w> </span><span class=c1># 5 minute cache</span>
<a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=w>    </span><span class=vi>@cache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=w>    </span><span class=vi>@ttl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ttl</span>
<a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=w>  </span><span class=k>end</span>
<a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a>
<a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=w>  </span><span class=k>def</span><span class=w> </span><span class=nf>model_for</span><span class=p>(</span><span class=n>root</span><span class=p>)</span>
<a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=w>    </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>root</span><span class=o>.</span><span class=n>to_s</span>
<a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=w>    </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>Time</span><span class=o>.</span><span class=n>now</span>
<a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a>
<a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=vi>@cache</span><span class=o>[</span><span class=n>key</span><span class=o>]</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>now</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=vi>@cache</span><span class=o>[</span><span class=n>key</span><span class=o>][</span><span class=ss>:time</span><span class=o>]</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=vi>@ttl</span><span class=p>)</span>
<a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=w>      </span><span class=vi>@cache</span><span class=o>[</span><span class=n>key</span><span class=o>][</span><span class=ss>:model</span><span class=o>]</span>
<a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=w>    </span><span class=k>else</span>
<a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=w>      </span><span class=vi>@cache</span><span class=o>[</span><span class=n>key</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a><span class=w>        </span><span class=ss>model</span><span class=p>:</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>root</span><span class=p>:</span><span class=w> </span><span class=n>root</span><span class=p>),</span>
<a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=w>        </span><span class=ss>time</span><span class=p>:</span><span class=w> </span><span class=n>now</span>
<a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a><span class=w>      </span><span class=p>}</span>
<a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a><span class=w>      </span><span class=vi>@cache</span><span class=o>[</span><span class=n>key</span><span class=o>][</span><span class=ss>:model</span><span class=o>]</span>
<a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a><span class=w>    </span><span class=k>end</span>
<a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=w>  </span><span class=k>end</span>
<a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a><span class=k>end</span>
<a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a>
<a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a><span class=n>cache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CoverageCache</span><span class=o>.</span><span class=n>new</span>
<a id=__codelineno-29-24 name=__codelineno-29-24 href=#__codelineno-29-24></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cache</span><span class=o>.</span><span class=n>model_for</span><span class=p>(</span><span class=s1>&#39;/path/to/project&#39;</span><span class=p>)</span>
</code></pre></div> <hr> <h2 id=custom-output-processing>Custom Output Processing<a class=headerlink href=#custom-output-processing title="Permanent link">&para;</a></h2> <h3 id=format-conversion>Format Conversion<a class=headerlink href=#format-conversion title="Permanent link">&para;</a></h3> <p><strong>CSV Export:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=nb>require</span><span class=w> </span><span class=s1>&#39;csv&#39;</span>
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>
<a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span>
<a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=n>files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>]</span>
<a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a>
<a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=no>CSV</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s1>&#39;coverage.csv&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;w&#39;</span><span class=p>)</span><span class=w> </span><span class=k>do</span><span class=w> </span><span class=o>|</span><span class=n>csv</span><span class=o>|</span>
<a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=w>  </span><span class=n>csv</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=o>[</span><span class=s1>&#39;File&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Coverage %&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Lines Covered&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Total Lines&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Stale&#39;</span><span class=o>]</span>
<a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=w>  </span><span class=n>files</span><span class=o>.</span><span class=n>each</span><span class=w> </span><span class=k>do</span><span class=w> </span><span class=o>|</span><span class=n>f</span><span class=o>|</span>
<a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=w>    </span><span class=n>csv</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=o>[</span>
<a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=w>      </span><span class=n>model</span><span class=o>.</span><span class=n>relativize</span><span class=p>(</span><span class=n>f</span><span class=p>)</span><span class=o>[</span><span class=s1>&#39;file&#39;</span><span class=o>]</span><span class=p>,</span>
<a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=w>      </span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;percentage&#39;</span><span class=o>]</span><span class=p>,</span>
<a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=w>      </span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;covered&#39;</span><span class=o>]</span><span class=p>,</span>
<a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=w>      </span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;total&#39;</span><span class=o>]</span><span class=p>,</span>
<a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=w>      </span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;stale&#39;</span><span class=o>]</span>
<a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=w>    </span><span class=o>]</span>
<a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=w>  </span><span class=k>end</span>
<a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a><span class=k>end</span>
</code></pre></div></p> <p><strong>HTML Report:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=nb>require</span><span class=w> </span><span class=s1>&#39;erb&#39;</span>
<a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>
<a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=n>template</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>ERB</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=o>&lt;&lt;~</span><span class=dl>HTML</span><span class=p>)</span>
<a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=sh>  &lt;html&gt;</span>
<a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=sh>    &lt;head&gt;&lt;title&gt;Coverage Report&lt;/title&gt;&lt;/head&gt;</span>
<a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=sh>    &lt;body&gt;</span>
<a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=sh>      &lt;h1&gt;Coverage Report&lt;/h1&gt;</span>
<a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=sh>      &lt;table&gt;</span>
<a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=sh>        &lt;tr&gt;</span>
<a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=sh>          &lt;th&gt;File&lt;/th&gt;&lt;th&gt;Coverage&lt;/th&gt;&lt;th&gt;Covered&lt;/th&gt;&lt;th&gt;Total&lt;/th&gt;</span>
<a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=sh>        &lt;/tr&gt;</span>
<a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=sh>        &lt;% files.each do |f| %&gt;</span>
<a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=sh>          &lt;tr class=&quot;&lt;%= f[&#39;percentage&#39;] &lt; 80 ? &#39;low&#39; : &#39;ok&#39; %&gt;&quot;&gt;</span>
<a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a><span class=sh>            &lt;td&gt;&lt;%= f[&#39;file&#39;] %&gt;&lt;/td&gt;</span>
<a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=sh>            &lt;td&gt;&lt;%= f[&#39;percentage&#39;].round(2) %&gt;%&lt;/td&gt;</span>
<a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=sh>            &lt;td&gt;&lt;%= f[&#39;covered&#39;] %&gt;&lt;/td&gt;</span>
<a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a><span class=sh>            &lt;td&gt;&lt;%= f[&#39;total&#39;] %&gt;&lt;/td&gt;</span>
<a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a><span class=sh>          &lt;/tr&gt;</span>
<a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a><span class=sh>        &lt;% end %&gt;</span>
<a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a><span class=sh>      &lt;/table&gt;</span>
<a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a><span class=sh>    &lt;/body&gt;</span>
<a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a><span class=sh>  &lt;/html&gt;</span>
<a id=__codelineno-31-23 name=__codelineno-31-23 href=#__codelineno-31-23></a><span class=dl>HTML</span>
<a id=__codelineno-31-24 name=__codelineno-31-24 href=#__codelineno-31-24></a>
<a id=__codelineno-31-25 name=__codelineno-31-25 href=#__codelineno-31-25></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span>
<a id=__codelineno-31-26 name=__codelineno-31-26 href=#__codelineno-31-26></a><span class=n>list_result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>list</span>
<a id=__codelineno-31-27 name=__codelineno-31-27 href=#__codelineno-31-27></a><span class=n>relative_list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>relativize</span><span class=p>(</span><span class=n>list_result</span><span class=p>)</span>
<a id=__codelineno-31-28 name=__codelineno-31-28 href=#__codelineno-31-28></a><span class=n>files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>relative_list</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>]</span>
<a id=__codelineno-31-29 name=__codelineno-31-29 href=#__codelineno-31-29></a><span class=no>File</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;coverage.html&#39;</span><span class=p>,</span><span class=w> </span><span class=n>template</span><span class=o>.</span><span class=n>result</span><span class=p>(</span><span class=nb>binding</span><span class=p>))</span>
</code></pre></div></p> <h3 id=annotated-source-output>Annotated Source Output<a class=headerlink href=#annotated-source-output title="Permanent link">&para;</a></h3> <p>The CLI supports annotated source viewing:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=c1># Show uncovered lines with context</span>
<a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>clp<span class=w> </span>uncovered<span class=w> </span>app/models/order.rb<span class=w> </span><span class=se>\</span>
<a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=w>  </span>-s<span class=w> </span>uncovered<span class=w> </span><span class=se>\</span>
<a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=w>  </span>-c<span class=w> </span><span class=m>3</span><span class=w>  </span><span class=c1># -s = --source, -c = --context-lines</span>
<a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a>
<a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=c1># Show full file with coverage annotations</span>
<a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a>clp<span class=w> </span>uncovered<span class=w> </span>app/models/order.rb<span class=w> </span><span class=se>\</span>
<a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a><span class=w>  </span>-s<span class=w> </span>full<span class=w> </span><span class=se>\</span>
<a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=w>  </span>-c<span class=w> </span><span class=m>0</span>
</code></pre></div> <p><strong>Programmatic Source Annotation:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=k>def</span><span class=w> </span><span class=nf>annotate_source</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
<a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=w>  </span><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span>
<a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=w>  </span><span class=n>details</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>detailed_for</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
<a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=w>  </span><span class=n>source_lines</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>File</span><span class=o>.</span><span class=n>readlines</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
<a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a>
<a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=w>  </span><span class=n>output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[]</span>
<a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a><span class=w>  </span><span class=n>details</span><span class=o>[</span><span class=s1>&#39;lines&#39;</span><span class=o>].</span><span class=n>each</span><span class=w> </span><span class=k>do</span><span class=w> </span><span class=o>|</span><span class=n>line_data</span><span class=o>|</span>
<a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=w>    </span><span class=n>line_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>line_data</span><span class=o>[</span><span class=s1>&#39;line&#39;</span><span class=o>]</span>
<a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a><span class=w>    </span><span class=n>hits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>line_data</span><span class=o>[</span><span class=s1>&#39;hits&#39;</span><span class=o>]</span>
<a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=w>    </span><span class=n>source</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>source_lines</span><span class=o>[</span><span class=n>line_num</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=o>]</span>
<a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a>
<a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a><span class=w>    </span><span class=n>marker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>case</span><span class=w> </span><span class=n>hits</span>
<a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a><span class=w>             </span><span class=k>when</span><span class=w> </span><span class=kp>nil</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=s1>&#39;     &#39;</span>
<a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a><span class=w>             </span><span class=k>when</span><span class=w> </span><span class=mi>0</span><span class=w>   </span><span class=k>then</span><span class=w> </span><span class=s1>&#39;    &#39;</span>
<a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a><span class=w>             </span><span class=k>else</span><span class=w>          </span><span class=s2>&quot;  </span><span class=si>#{</span><span class=n>hits</span><span class=si>}</span><span class=s2>  &quot;</span>
<a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a><span class=w>             </span><span class=k>end</span>
<a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a>
<a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a><span class=w>    </span><span class=n>output</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s2>&quot;</span><span class=si>#{</span><span class=n>marker</span><span class=si>}#{</span><span class=n>line_num</span><span class=o>.</span><span class=n>to_s</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span><span class=si>}</span><span class=s2>: </span><span class=si>#{</span><span class=n>source</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a><span class=w>  </span><span class=k>end</span>
<a id=__codelineno-33-20 name=__codelineno-33-20 href=#__codelineno-33-20></a>
<a id=__codelineno-33-21 name=__codelineno-33-21 href=#__codelineno-33-21></a><span class=w>  </span><span class=n>output</span><span class=o>.</span><span class=n>join</span>
<a id=__codelineno-33-22 name=__codelineno-33-22 href=#__codelineno-33-22></a><span class=k>end</span>
<a id=__codelineno-33-23 name=__codelineno-33-23 href=#__codelineno-33-23></a>
<a id=__codelineno-33-24 name=__codelineno-33-24 href=#__codelineno-33-24></a><span class=nb>puts</span><span class=w> </span><span class=n>annotate_source</span><span class=p>(</span><span class=s1>&#39;app/models/order.rb&#39;</span><span class=p>)</span>
</code></pre></div></p> <h3 id=integration-with-coverage-trackers>Integration with Coverage Trackers<a class=headerlink href=#integration-with-coverage-trackers title="Permanent link">&para;</a></h3> <p><strong>Send to Codecov:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=ch>#!/bin/bash</span>
<a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a>bundle<span class=w> </span><span class=nb>exec</span><span class=w> </span>rspec
<a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a>clp<span class=w> </span>-fJ<span class=w> </span>list<span class=w> </span>&gt;<span class=w> </span>coverage.json
<a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a>
<a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=c1># Transform to Codecov format (example)</span>
<a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a>jq<span class=w> </span><span class=s1>&#39;{</span>
<a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=s1>  coverage: [</span>
<a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=s1>    .files[] | {</span>
<a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=s1>      name: .file,</span>
<a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a><span class=s1>      coverage: .percentage</span>
<a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=s1>    }</span>
<a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=s1>  ]</span>
<a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=s1>}&#39;</span><span class=w> </span>coverage.json<span class=w> </span><span class=p>|</span><span class=w> </span>curl<span class=w> </span>-X<span class=w> </span>POST<span class=w> </span><span class=se>\</span>
<a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=w>  </span>-H<span class=w> </span><span class=s2>&quot;Authorization: token </span><span class=nv>$CODECOV_TOKEN</span><span class=s2>&quot;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=w>  </span>-d<span class=w> </span>@-<span class=w> </span>https://codecov.io/upload
<a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a>
<a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a><span class=c1># Ruby alternative:</span>
<a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a>ruby<span class=w> </span>-r<span class=w> </span>json<span class=w> </span>-e<span class=w> </span><span class=s1>&#39;</span>
<a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a><span class=s1>  data = JSON.parse(File.read(&quot;coverage.json&quot;))</span>
<a id=__codelineno-34-20 name=__codelineno-34-20 href=#__codelineno-34-20></a><span class=s1>  transformed = {</span>
<a id=__codelineno-34-21 name=__codelineno-34-21 href=#__codelineno-34-21></a><span class=s1>    coverage: data[&quot;files&quot;].map { |f|</span>
<a id=__codelineno-34-22 name=__codelineno-34-22 href=#__codelineno-34-22></a><span class=s1>      {name: f[&quot;file&quot;], coverage: f[&quot;percentage&quot;]}</span>
<a id=__codelineno-34-23 name=__codelineno-34-23 href=#__codelineno-34-23></a><span class=s1>    }</span>
<a id=__codelineno-34-24 name=__codelineno-34-24 href=#__codelineno-34-24></a><span class=s1>  }</span>
<a id=__codelineno-34-25 name=__codelineno-34-25 href=#__codelineno-34-25></a><span class=s1>  puts JSON.pretty_generate(transformed)</span>
<a id=__codelineno-34-26 name=__codelineno-34-26 href=#__codelineno-34-26></a><span class=s1>&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>curl<span class=w> </span>-X<span class=w> </span>POST<span class=w> </span><span class=se>\</span>
<a id=__codelineno-34-27 name=__codelineno-34-27 href=#__codelineno-34-27></a><span class=w>  </span>-H<span class=w> </span><span class=s2>&quot;Authorization: token </span><span class=nv>$CODECOV_TOKEN</span><span class=s2>&quot;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-34-28 name=__codelineno-34-28 href=#__codelineno-34-28></a><span class=w>  </span>-d<span class=w> </span>@-<span class=w> </span>https://codecov.io/upload
<a id=__codelineno-34-29 name=__codelineno-34-29 href=#__codelineno-34-29></a>
<a id=__codelineno-34-30 name=__codelineno-34-30 href=#__codelineno-34-30></a><span class=c1># Rexe alternative:</span>
<a id=__codelineno-34-31 name=__codelineno-34-31 href=#__codelineno-34-31></a>rexe<span class=w> </span>-f<span class=w> </span>coverage.json<span class=w> </span>-oJ<span class=w> </span><span class=s1>&#39;</span>
<a id=__codelineno-34-32 name=__codelineno-34-32 href=#__codelineno-34-32></a><span class=s1>  {</span>
<a id=__codelineno-34-33 name=__codelineno-34-33 href=#__codelineno-34-33></a><span class=s1>    coverage: self[&quot;files&quot;].map { |f|</span>
<a id=__codelineno-34-34 name=__codelineno-34-34 href=#__codelineno-34-34></a><span class=s1>      {name: f[&quot;file&quot;], coverage: f[&quot;percentage&quot;]}</span>
<a id=__codelineno-34-35 name=__codelineno-34-35 href=#__codelineno-34-35></a><span class=s1>    }</span>
<a id=__codelineno-34-36 name=__codelineno-34-36 href=#__codelineno-34-36></a><span class=s1>  }</span>
<a id=__codelineno-34-37 name=__codelineno-34-37 href=#__codelineno-34-37></a><span class=s1>&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>curl<span class=w> </span>-X<span class=w> </span>POST<span class=w> </span><span class=se>\</span>
<a id=__codelineno-34-38 name=__codelineno-34-38 href=#__codelineno-34-38></a><span class=w>  </span>-H<span class=w> </span><span class=s2>&quot;Authorization: token </span><span class=nv>$CODECOV_TOKEN</span><span class=s2>&quot;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-34-39 name=__codelineno-34-39 href=#__codelineno-34-39></a><span class=w>  </span>-d<span class=w> </span>@-<span class=w> </span>https://codecov.io/upload
</code></pre></div></p> <p><strong>Send to Coveralls:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=nb>require</span><span class=w> </span><span class=s1>&#39;cov_loupe&#39;</span>
<a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=nb>require</span><span class=w> </span><span class=s1>&#39;net/http&#39;</span>
<a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=nb>require</span><span class=w> </span><span class=s1>&#39;json&#39;</span>
<a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a>
<a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=n>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>CovLoupe</span><span class=o>::</span><span class=no>CoverageModel</span><span class=o>.</span><span class=n>new</span>
<a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=n>files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>list</span><span class=o>[</span><span class=s1>&#39;files&#39;</span><span class=o>]</span>
<a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a>
<a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=n>coveralls_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=w>  </span><span class=ss>repo_token</span><span class=p>:</span><span class=w> </span><span class=no>ENV</span><span class=o>[</span><span class=s1>&#39;COVERALLS_REPO_TOKEN&#39;</span><span class=o>]</span><span class=p>,</span>
<a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=w>  </span><span class=ss>source_files</span><span class=p>:</span><span class=w> </span><span class=n>files</span><span class=o>.</span><span class=n>map</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>|</span><span class=n>f</span><span class=o>|</span>
<a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=w>      </span><span class=nb>name</span><span class=p>:</span><span class=w> </span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;file&#39;</span><span class=o>]</span><span class=p>,</span>
<a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=w>      </span><span class=ss>coverage</span><span class=p>:</span><span class=w> </span><span class=n>model</span><span class=o>.</span><span class=n>raw_for</span><span class=p>(</span><span class=n>f</span><span class=o>[</span><span class=s1>&#39;file&#39;</span><span class=o>]</span><span class=p>)</span><span class=o>[</span><span class=s1>&#39;lines&#39;</span><span class=o>]</span>
<a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a><span class=p>}</span>
<a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a>
<a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a><span class=n>uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>URI</span><span class=p>(</span><span class=s1>&#39;https://coveralls.io/api/v1/jobs&#39;</span><span class=p>)</span>
<a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a><span class=no>Net</span><span class=o>::</span><span class=no>HTTP</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=n>coveralls_data</span><span class=o>.</span><span class=n>to_json</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a><span class=w>  </span><span class=s1>&#39;Content-Type&#39;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>&#39;application/json&#39;</span>
<a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a><span class=p>})</span>
</code></pre></div></p> <hr> <h2 id=multi-suite-coverage-merging>Multi-Suite Coverage Merging<a class=headerlink href=#multi-suite-coverage-merging title="Permanent link">&para;</a></h2> <h3 id=how-it-works>How It Works<a class=headerlink href=#how-it-works title="Permanent link">&para;</a></h3> <p>When a <code>.resultset.json</code> file contains multiple test suites (e.g., RSpec + Cucumber), <code>cov-loupe</code> automatically merges them using SimpleCov's combine logic. All covered files from every suite become available to the CLI, library, and MCP tools.</p> <p><strong>Performance:</strong> Single-suite projects avoid loading SimpleCov at runtime. Multi-suite resultsets trigger a lazy SimpleCov load only when needed, keeping the tool fast for the simpler coverage configurations.</p> <h3 id=current-limitations>Current Limitations<a class=headerlink href=#current-limitations title="Permanent link">&para;</a></h3> <p><strong>Staleness checks:</strong> When suites are merged, we keep a single "latest suite" timestamp. This matches prior behavior but may under-report stale files if only some suites were re-run after a change. Use <code>--raise-on-stale</code> (or <code>-S</code>) on the CLI, <code>raise_on_stale: true</code> via the Ruby API, or the MCP tool parameter to turn these warnings into hard failures. A per-file timestamp refinement is planned; until then, treat multi-suite staleness flags as advisory rather than definitive.</p> <p><strong>Multiple resultset files:</strong> Only suites stored inside a <em>single</em> <code>.resultset.json</code> are merged automatically. If your project produces separate resultset files (e.g., different CI jobs writing <code>coverage/job1/.resultset.json</code>, <code>coverage/job2/.resultset.json</code>), you must merge them yourself before pointing <code>cov-loupe</code> at the combined file.</p> <hr> <h2 id=additional-resources>Additional Resources<a class=headerlink href=#additional-resources title="Permanent link">&para;</a></h2> <ul> <li><a href=../CLI_USAGE/ >CLI Usage Guide</a></li> <li><a href=../LIBRARY_API/ >Library API Reference</a></li> <li><a href=../MCP_INTEGRATION/ >MCP Integration Guide</a></li> <li><a href=../ERROR_HANDLING/ >Error Handling Details</a></li> <li><a href=../TROUBLESHOOTING/ >Troubleshooting</a></li> </ul> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../LIBRARY_API/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Library API"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Library API </div> </div> </a> <a href=../ERROR_HANDLING/ class="md-footer__link md-footer__link--next" aria-label="Next: Error Handling"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Error Handling </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> </div> <div class=md-social> <a href=https://github.com/keithrbennett/cov-loupe target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://rubygems.org/gems/cov-loupe target=_blank rel=noopener title=rubygems.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M116.7 33.8c4.5-6.1 11.7-9.8 19.3-9.8h240c7.6 0 14.8 3.6 19.3 9.8l112 152c6.8 9.2 6.1 21.9-1.5 30.4l-232 256c-4.5 5-11 7.9-17.8 7.9s-13.2-2.9-17.8-7.9l-232-256c-7.7-8.5-8.3-21.2-1.5-30.4zm38.5 39.8c-3.3 2.5-4.2 7-2.1 10.5l57.4 95.7L63.3 192c-4.1.3-7.3 3.8-7.3 8s3.2 7.6 7.3 8l192 16h1.3l192-16c4.1-.3 7.3-3.8 7.3-8s-3.2-7.6-7.3-8l-147.2-12.3 57.4-95.6c2.1-3.5 1.2-8.1-2.1-10.5s-7.9-2-10.7 1l-90 97.6-90.1-97.6c-2.8-3-7.4-3.4-10.7-1"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "navigation.expand", "navigation.footer", "navigation.sections", "navigation.tabs", "navigation.top", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> </body> </html>